<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fish 3D Digital Twin Viewer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // SAME DATABASE as the QR system - Keep this synchronized!
        const fishData = [
          {
            id: "A-1001",
            species: "Atlantic Cod",
            catchDate: "2025/11/28",
            location: "Gulf of Maine",
            processing: "Filet & Flash Frozen",
            quality: 5,
            temperature: "Maintained -18¬∞C throughout storage",
            notes: "Excellent, premium grade. Used for high-end restaurant supply.",
            blockchainHash: "0x7f9fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a91385",
            color: 0x8B7355,
            size: 1.2
          },
          {
            id: "B-1002",
            species: "Sockeye Salmon",
            catchDate: "2025/11/29",
            location: "Alaska Peninsula",
            processing: "Whole, Gilled & Gutted",
            quality: 4,
            temperature: "Kept under 2¬∞C on ice slurry",
            notes: "Good fat content, eyes slightly cloudy due to ice contact. Very fresh.",
            blockchainHash: "0x3c2c2eb7b11a91385fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7",
            color: 0xFF6B6B,
            size: 1.0
          },
          {
            id: "C-1003",
            species: "Yellowfin Tuna",
            catchDate: "2025/11/26",
            location: "Eastern Pacific",
            processing: "Loin, Vacuum Sealed",
            quality: 5,
            temperature: "-0.5¬∞C for chilling, air blast -35¬∞C freezing",
            notes: "Sushi-grade quality. Firm texture, vibrant red color. Traceable to vessel 'Sea Star'.",
            blockchainHash: "0x91385fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a9",
            color: 0x4A90E2,
            size: 1.5
          },
          {
            id: "D-1004",
            species: "Farmed Tilapia",
            catchDate: "2025/11/30",
            location: "Aquaculture Pond 4",
            processing: "Live Harvest/Chilled",
            quality: 3,
            temperature: "Consistent 3¬∞C after harvest",
            notes: "Acceptable quality for general market. Slight feed discoloration near the gills.",
            blockchainHash: "0x4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a91385fade1c0d57a7af66ab4e",
            color: 0xD4AF37,
            size: 0.8
          },
          {
            id: "E-1005",
            species: "European Seabass",
            catchDate: "2025/11/27",
            location: "Mediterranean Sea",
            processing: "Whole, Cleaned, Iced",
            quality: 5,
            temperature: "Never exceeded 1¬∞C",
            notes: "Top-tier quality, certified sustainable catch. Clear eyes, bright red gills.",
            blockchainHash: "0x5fade1c0d57a7af66ab4ead7c2c2eb7b11a91385fade1c0d57a7af66ab4ead79f",
            color: 0xC0C0C0,
            size: 1.1
          },
          {
            id: "F-1006",
            species: "Haddock",
            catchDate: "2025/11/29",
            location: "North Atlantic",
            processing: "Fillet (Skin On)",
            quality: 4,
            temperature: "Held at 0¬∞C",
            notes: "Minor bruising on two pieces from net, but flesh is firm and white.",
            blockchainHash: "0x6ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a91385fade1c0d57a7af66a",
            color: 0x696969,
            size: 0.9
          },
          {
            id: "G-1007",
            species: "Pacific Halibut",
            catchDate: "2025/11/25",
            location: "Bering Sea",
            processing: "Steaks, Individually Wrapped",
            quality: 5,
            temperature: "Deep frozen at -30¬∞C",
            notes: "Highest grade. Perfect white meat. Harvested by long-line, low stress.",
            blockchainHash: "0x7c2c2eb7b11a91385fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7c",
            color: 0xF5F5DC,
            size: 1.6
          },
          {
            id: "H-1008",
            species: "Mackerel",
            catchDate: "2025/11/28",
            location: "North Sea",
            processing: "Whole, Bulk Frozen",
            quality: 3,
            temperature: "Rapid freeze, held at -20¬∞C",
            notes: "Standard quality, good for processing. A few fish show signs of scale loss.",
            blockchainHash: "0x8fade1c0d57a7af66ab4ead7c2c2eb7b11a91385fade1c0d57a7af66ab4ead79",
            color: 0x4682B4,
            size: 0.7
          },
          {
            id: "I-1009",
            species: "Rainbow Trout",
            catchDate: "2025/11/30",
            location: "Local Fish Farm",
            processing: "Whole, Smoked",
            quality: 4,
            temperature: "Product finished smoking at 65¬∞C",
            notes: "Smoked on oak wood. Good moisture content, slight breakage on tail fin.",
            blockchainHash: "0x9a91385fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a",
            color: 0xFF1493,
            size: 0.85
          },
          {
            id: "J-1010",
            species: "King Prawns",
            catchDate: "2025/11/27",
            location: "Southeast Asia",
            processing: "Shell-on, Cooked, Frozen",
            quality: 5,
            temperature: "Boiled then blast frozen to -18¬∞C",
            notes: "Excellent texture and color. Zero defects noted in inspection batch.",
            blockchainHash: "0xa66ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a91385fade1c0d57a7af6",
            color: 0xFF6347,
            size: 0.6
          }
        ];

        const Fish3DAvatar = ({ fish, showControls = true }) => {
          const mountRef = useRef(null);
          const sceneRef = useRef(null);
          const fishMeshRef = useRef(null);
          const [rotation, setRotation] = useState(0);
          const [autoRotate, setAutoRotate] = useState(true);

          useEffect(() => {
            if (!mountRef.current) return;

            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1e3a5f);
            sceneRef.current = scene;

            const camera = new THREE.PerspectiveCamera(
              75,
              mountRef.current.clientWidth / mountRef.current.clientHeight,
              0.1,
              1000
            );
            camera.position.z = 5;

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
            mountRef.current.appendChild(renderer.domElement);

            // Enhanced lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0x00ffff, 0.5);
            pointLight.position.set(-5, 3, 3);
            scene.add(pointLight);

            // Create fish body
            const bodyGeometry = new THREE.SphereGeometry(fish.size, 32, 32);
            bodyGeometry.scale(1.8, 0.8, 0.6);
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
              color: fish.color,
              shininess: 100,
              specular: 0x444444
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);

            // Create tail
            const tailGeometry = new THREE.ConeGeometry(fish.size * 0.5, fish.size * 0.8, 3);
            tailGeometry.rotateZ(Math.PI / 2);
            const tailMaterial = new THREE.MeshPhongMaterial({ 
              color: fish.color,
              shininess: 80
            });
            const tail = new THREE.Mesh(tailGeometry, tailMaterial);
            tail.position.set(-fish.size * 1.5, 0, 0);

            // Create fins
            const finGeometry = new THREE.ConeGeometry(fish.size * 0.3, fish.size * 0.5, 3);
            const finMaterial = new THREE.MeshPhongMaterial({ color: fish.color });
            
            const topFin = new THREE.Mesh(finGeometry, finMaterial);
            topFin.position.set(0, fish.size * 0.8, 0);
            topFin.rotation.x = Math.PI;

            const sideFin1 = new THREE.Mesh(finGeometry, finMaterial);
            sideFin1.position.set(fish.size * 0.3, -fish.size * 0.4, fish.size * 0.4);
            sideFin1.rotation.z = Math.PI / 4;
            sideFin1.scale.set(0.6, 0.6, 0.6);

            const sideFin2 = new THREE.Mesh(finGeometry, finMaterial);
            sideFin2.position.set(fish.size * 0.3, -fish.size * 0.4, -fish.size * 0.4);
            sideFin2.rotation.z = Math.PI / 4;
            sideFin2.scale.set(0.6, 0.6, 0.6);

            // Create eyes
            const eyeGeometry = new THREE.SphereGeometry(fish.size * 0.15, 16, 16);
            const eyeMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
            const pupilMaterial = new THREE.MeshPhongMaterial({ color: 0x000000 });

            const eye1 = new THREE.Mesh(eyeGeometry, eyeMaterial);
            eye1.position.set(fish.size * 1.2, fish.size * 0.3, fish.size * 0.3);

            const pupil1 = new THREE.Mesh(
              new THREE.SphereGeometry(fish.size * 0.08, 16, 16),
              pupilMaterial
            );
            pupil1.position.set(fish.size * 1.3, fish.size * 0.3, fish.size * 0.3);

            const eye2 = new THREE.Mesh(eyeGeometry, eyeMaterial);
            eye2.position.set(fish.size * 1.2, fish.size * 0.3, -fish.size * 0.3);

            const pupil2 = new THREE.Mesh(
              new THREE.SphereGeometry(fish.size * 0.08, 16, 16),
              pupilMaterial
            );
            pupil2.position.set(fish.size * 1.3, fish.size * 0.3, -fish.size * 0.3);

            // Group all parts
            const fishGroup = new THREE.Group();
            fishGroup.add(body);
            fishGroup.add(tail);
            fishGroup.add(topFin);
            fishGroup.add(sideFin1);
            fishGroup.add(sideFin2);
            fishGroup.add(eye1);
            fishGroup.add(eye2);
            fishGroup.add(pupil1);
            fishGroup.add(pupil2);

            scene.add(fishGroup);
            fishMeshRef.current = fishGroup;

            // Add bubbles
            const bubbles = [];
            for (let i = 0; i < 20; i++) {
              const bubbleGeometry = new THREE.SphereGeometry(0.08 + Math.random() * 0.12, 16, 16);
              const bubbleMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xadd8e6,
                transparent: true,
                opacity: 0.3 + Math.random() * 0.3
              });
              const bubble = new THREE.Mesh(bubbleGeometry, bubbleMaterial);
              bubble.position.set(
                Math.random() * 10 - 5,
                Math.random() * 6 - 3,
                Math.random() * 6 - 3
              );
              scene.add(bubble);
              bubbles.push({ 
                mesh: bubble, 
                speed: 0.01 + Math.random() * 0.03,
                wobble: Math.random() * 0.02
              });
            }

            // Animation
            let time = 0;
            const animate = () => {
              requestAnimationFrame(animate);
              time += 0.01;

              if (fishMeshRef.current) {
                if (autoRotate) {
                  fishMeshRef.current.rotation.y = Math.sin(time * 0.5) * 0.4 + rotation;
                } else {
                  fishMeshRef.current.rotation.y = rotation;
                }
                fishMeshRef.current.position.y = Math.sin(time) * 0.3;
                fishMeshRef.current.position.x = Math.cos(time * 0.3) * 0.5;

                // Animate tail
                tail.rotation.y = Math.sin(time * 5) * 0.3;
                
                // Animate side fins
                sideFin1.rotation.z = Math.PI / 4 + Math.sin(time * 4) * 0.2;
                sideFin2.rotation.z = Math.PI / 4 + Math.sin(time * 4) * 0.2;
              }

              // Animate bubbles
              bubbles.forEach(bubble => {
                bubble.mesh.position.y += bubble.speed;
                bubble.mesh.position.x += Math.sin(time * 2 + bubble.mesh.position.y) * bubble.wobble;
                if (bubble.mesh.position.y > 3) {
                  bubble.mesh.position.y = -3;
                  bubble.mesh.position.x = Math.random() * 10 - 5;
                }
              });

              renderer.render(scene, camera);
            };

            animate();

            const handleResize = () => {
              if (mountRef.current) {
                camera.aspect = mountRef.current.clientWidth / mountRef.current.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
              }
            };

            window.addEventListener('resize', handleResize);

            return () => {
              window.removeEventListener('resize', handleResize);
              if (mountRef.current && mountRef.current.contains(renderer.domElement)) {
                mountRef.current.removeChild(renderer.domElement);
              }
            };
          }, [fish, rotation, autoRotate]);

          return (
            <div className="relative">
              <div ref={mountRef} style={{ width: '100%', height: '500px', borderRadius: '12px', overflow: 'hidden' }} />
              {showControls && (
                <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white bg-opacity-90 rounded-lg p-4 shadow-lg">
                  <div className="flex items-center gap-4">
                    <button
                      onClick={() => setRotation(r => r - 0.5)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      ‚Üê Rotate Left
                    </button>
                    <label className="flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={autoRotate}
                        onChange={(e) => setAutoRotate(e.target.checked)}
                        className="w-4 h-4"
                      />
                      <span className="text-sm font-medium">Auto-rotate</span>
                    </label>
                    <button
                      onClick={() => setRotation(r => r + 0.5)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      Rotate Right ‚Üí
                    </button>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const FishSelector = ({ fishData, onSelect, selectedFish }) => {
          return (
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
              {fishData.map((fish) => (
                <button
                  key={fish.id}
                  onClick={() => onSelect(fish)}
                  className={`p-3 rounded-lg border-2 transition-all text-left ${
                    selectedFish?.id === fish.id
                      ? 'border-blue-600 bg-blue-50 shadow-lg'
                      : 'border-gray-300 bg-white hover:border-blue-400 hover:shadow-md'
                  }`}
                >
                  <div className="font-mono text-xs text-gray-500">{fish.id}</div>
                  <div className="font-semibold text-sm mt-1">{fish.species}</div>
                  <div className="text-xs text-gray-600 mt-1">Quality: {'‚òÖ'.repeat(fish.quality)}</div>
                </button>
              ))}
            </div>
          );
        };

        const FishDetails = ({ fish }) => {
          const qualityColor = fish.quality >= 5 ? 'text-green-600' : fish.quality >= 4 ? 'text-blue-600' : 'text-yellow-600';
          
          return (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-white rounded-lg p-4 shadow-lg border-2 border-blue-200">
                <div className="text-blue-700 font-semibold mb-2 flex items-center gap-2">
                  <span>üìç</span> Catch Information
                </div>
                <div className="space-y-1 text-sm">
                  <p><span className="font-medium">Date:</span> {fish.catchDate}</p>
                  <p><span className="font-medium">Location:</span> {fish.location}</p>
                </div>
              </div>

              <div className="bg-white rounded-lg p-4 shadow-lg border-2 border-blue-200">
                <div className="text-blue-700 font-semibold mb-2 flex items-center gap-2">
                  <span>üì¶</span> Processing Method
                </div>
                <div className="space-y-1 text-sm">
                  <p>{fish.processing}</p>
                </div>
              </div>

              <div className="bg-white rounded-lg p-4 shadow-lg border-2 border-blue-200">
                <div className="text-blue-700 font-semibold mb-2 flex items-center gap-2">
                  <span>üå°Ô∏è</span> Temperature Log
                </div>
                <div className="space-y-1 text-sm">
                  <p>{fish.temperature}</p>
                </div>
              </div>

              <div className="bg-white rounded-lg p-4 shadow-lg border-2 border-blue-200">
                <div className="text-blue-700 font-semibold mb-2 flex items-center gap-2">
                  <span>‚≠ê</span> Quality Rating
                </div>
                <div className={`text-3xl ${qualityColor}`}>
                  {'‚òÖ'.repeat(fish.quality)}{'‚òÜ'.repeat(5 - fish.quality)}
                </div>
              </div>

              <div className="bg-white rounded-lg p-4 shadow-lg border-2 border-blue-200 md:col-span-2">
                <div className="text-blue-700 font-semibold mb-2 flex items-center gap-2">
                  <span>‚ÑπÔ∏è</span> Quality Notes
                </div>
                <div className="space-y-1 text-sm">
                  <p>{fish.notes}</p>
                </div>
              </div>

              <div className="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 border-2 border-purple-200 md:col-span-2">
                <div className="text-purple-700 font-semibold mb-2 flex items-center gap-2">
                  <span>üõ°Ô∏è</span> Blockchain Hash
                </div>
                <div className="font-mono text-xs break-all text-gray-700 bg-white p-2 rounded">
                  {fish.blockchainHash}
                </div>
              </div>
            </div>
          );
        };

        const App = () => {
          const [selectedFish, setSelectedFish] = useState(fishData[0]);

          // Check URL for fish ID
          useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            const fishId = urlParams.get('id');
            
            if (fishId) {
              const fish = fishData.find(f => f.id === fishId);
              if (fish) {
                setSelectedFish(fish);
              }
            }
          }, []);

          return (
            <div className="min-h-screen bg-gradient-to-b from-blue-100 to-cyan-100 p-8">
              <div className="max-w-7xl mx-auto">
                <div className="text-center mb-8">
                  <h1 className="text-4xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
                    <span>üêü</span> 3D Fish Digital Twin Viewer
                  </h1>
                  <p className="text-gray-600">Interactive 3D visualization of fish inventory</p>
                </div>

                <div className="bg-gradient-to-br from-blue-900 via-blue-800 to-cyan-900 rounded-xl p-6 mb-6 shadow-2xl">
                  <div className="text-white mb-4">
                    <h2 className="text-3xl font-bold flex items-center gap-2">
                      <span>üêü</span> {selectedFish.species}
                    </h2>
                    <p className="text-blue-200 font-mono text-sm mt-1">Digital Twin ID: {selectedFish.id}</p>
                  </div>

                  <Fish3DAvatar fish={selectedFish} showControls={true} />

                  <div className="mt-4 text-center text-white text-sm bg-blue-800 bg-opacity-50 rounded-lg p-3">
                    <p className="font-semibold">üåä Real-time 3D Simulation</p>
                    <p className="text-xs text-blue-200">Use controls to rotate ‚Ä¢ Auto-rotation available</p>
                  </div>
                </div>

                <div className="mb-6">
                  <h3 className="text-xl font-bold text-gray-800 mb-3">Select a Fish to View:</h3>
                  <FishSelector 
                    fishData={fishData} 
                    onSelect={setSelectedFish}
                    selectedFish={selectedFish}
                  />
                </div>

                <div className="mb-6">
                  <h3 className="text-xl font-bold text-gray-800 mb-3">Fish Details:</h3>
                  <FishDetails fish={selectedFish} />
                </div>

                <div className="text-center text-sm text-gray-600 bg-white rounded-lg p-4 shadow-sm">
                  <p className="font-semibold mb-2">üí° How to Use:</p>
                  <p>Select any fish from the grid above to view its 3D digital twin.</p>
                  <p className="mt-2">Use the rotation controls to inspect the fish from different angles.</p>
                  <p className="mt-2">This viewer uses the same database as the QR code system.</p>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
